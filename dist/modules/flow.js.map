{"version":3,"file":"flow.js","sources":["../../src/modules/flow.js"],"sourcesContent":["/**\n * flow 流加载组件\n */\n\n  import { layui } from '../core.js';\n  import $ from 'jquery';\n\n  var Flow = function(options) {};\n  var ELEM_MORE = 'layui-flow-more';\n  var ELEM_LOAD = '<i class=\"layui-anim layui-anim-rotate layui-anim-loop layui-icon \">&#xe63e;</i>';\n\n  // 主方法\n  Flow.prototype.load = function(options) {\n    var that = this, page = 0, lock, isOver, lazyimg, timer;\n    options = options || {};\n\n    var elem = $(options.elem); if(!elem[0]) return;\n    var scrollElem = $(options.scrollElem || document); // 滚动条所在元素\n    var threshold = 'mb' in options ? options.mb : 50; // 临界距离\n    var isAuto = 'isAuto' in options ? options.isAuto : true; // 否自动滚动加载\n    var moreText = options.moreText || \"加载更多\"; // 手动加载时，加载更多按钮文案\n    var end = options.end || '没有更多了'; // “末页”显示文案\n    var direction = options.direction || 'bottom';\n    var isTop = direction === 'top';\n\n    // 重复执行时清理旧的事件绑定\n    that._cleanup(elem, scrollElem);\n\n    //滚动条所在元素是否为document\n    var notDocument = options.scrollElem && options.scrollElem !== document;\n\n    //加载更多\n    var ELEM_TEXT = '<cite>' + moreText + '</cite>'\n    ,more = $('<div class=\"layui-flow-more\"><a href=\"javascript:;\">'+ ELEM_TEXT +'</a></div>');\n\n    if(!elem.find('.layui-flow-more')[0]){\n      elem[isTop ? 'prepend' : 'append'](more);\n    }\n\n    //加载下一个元素\n    var next = function(html, over){\n      var scrollHeightStart = notDocument ? scrollElem.prop('scrollHeight') : document.documentElement.scrollHeight;\n      var scrollTopStart = scrollElem.scrollTop();\n      html = $(html);\n      more[isTop ? 'after' : 'before'](html);\n      over = over == 0 ? true : null;\n      over ? more.html(end) : more.find('a').html(ELEM_TEXT);\n      isOver = over;\n      lock = null;\n      lazyimg && lazyimg();\n      if(isTop){\n        var scrollHeightEnd = notDocument ? scrollElem.prop('scrollHeight') : document.documentElement.scrollHeight;\n        if(page === 1){\n          // 首次渲染后滑动到底部\n          scrollElem.scrollTop(scrollHeightEnd);\n        }else if(page > 1){\n          var nextElementHeight = scrollHeightEnd - scrollHeightStart;\n          scrollElem.scrollTop(scrollTopStart + nextElementHeight);\n        }\n      }\n    };\n\n    //触发请求\n    var done = function(){\n      lock = true;\n      more.find('a').html(ELEM_LOAD);\n      typeof options.done === 'function' && options.done(++page, next);\n    };\n\n    done();\n\n    //不自动滚动加载\n    more.find('a').on('click.flow', function(){\n      var othis = $(this);\n      if(isOver) return;\n      lock || done();\n    });\n\n    //如果允许图片懒加载\n    if(options.isLazyimg){\n      lazyimg = that.lazyimg({\n        elem: options.elem + ' img'\n        ,scrollElem: options.scrollElem\n        ,direction: options.direction\n      });\n    }\n\n    if(!isAuto) return that;\n\n    scrollElem.on('scroll.flow', function(){\n      var othis = $(this), top = othis.scrollTop();\n\n      if(timer) clearTimeout(timer);\n      if(isOver || !elem.width()) return; //如果已经结束，或者元素处于隐藏状态，则不执行滚动加载\n\n      timer = setTimeout(function(){\n        //计算滚动所在容器的可视高度\n        var height = notDocument ? othis.height() : $(window).height();\n\n        //计算滚动所在容器的实际高度\n        var scrollHeight = notDocument\n          ? othis.prop('scrollHeight')\n        : document.documentElement.scrollHeight;\n\n        //临界点\n        if(!isTop ? scrollHeight - top - height <= threshold : top <= threshold){\n          lock || done();\n        }\n      }, 100);\n    });\n\n    return that;\n  };\n\n  //图片懒加载\n  Flow.prototype.lazyimg = function(options){\n    var that = this, index = 0, haveScroll;\n    options = options || {};\n\n    var scrollElem = $(options.scrollElem || document); //滚动条所在元素\n    var elem = options.elem || 'img';\n    var direction = options.direction || 'bottom';\n    var isTop = direction === 'top';\n\n    //滚动条所在元素是否为document\n    var notDocument = options.scrollElem && options.scrollElem !== document;\n\n    //显示图片\n    var show = function(item, height){\n      var start = scrollElem.scrollTop(), end = start + height;\n      var elemTop = notDocument ? function(){\n        return item.offset().top - scrollElem.offset().top + start;\n      }() : item.offset().top;\n\n      /* 始终只加载在当前屏范围内的图片 */\n      if((isTop ? elemTop + item.height() : elemTop) >= start && elemTop <= end){\n        if(item.attr('lay-src')){\n          var src = item.attr('lay-src');\n          layui.img(src, function(){\n            var next = that.lazyimg.elem.eq(index);\n            item.attr('src', src).removeAttr('lay-src');\n\n            /* 当前图片加载就绪后，检测下一个图片是否在当前屏 */\n            next[0] && render(next);\n            index++;\n          }, function(){\n            var next = that.lazyimg.elem.eq(index);\n            item.removeAttr('lay-src');\n          });\n        }\n      }\n    }, render = function(othis, scroll){\n\n      //计算滚动所在容器的可视高度\n      var height = notDocument ? (scroll||scrollElem).height() : $(window).height();\n      var start = scrollElem.scrollTop(), end = start + height;\n\n      that.lazyimg.elem = $(elem);\n\n      if(othis){\n        show(othis, height);\n      } else {\n        //计算未加载过的图片\n        for(var i = 0; i < that.lazyimg.elem.length; i++){\n          var item = that.lazyimg.elem.eq(i), elemTop = notDocument ? function(){\n            return item.offset().top - scrollElem.offset().top + start;\n          }() : item.offset().top;\n\n          show(item, height);\n          index = i;\n\n          //如果图片的top坐标，超出了当前屏，则终止后续图片的遍历\n          if(elemTop > end) break;\n        }\n      }\n    };\n\n    render();\n\n    if(!haveScroll){\n      var timer;\n      scrollElem.on('scroll.lazyimg' , function(){\n        var othis = $(this);\n        if(timer) clearTimeout(timer)\n        timer = setTimeout(function(){\n          render(null, othis);\n        }, 50);\n      });\n      haveScroll = true;\n    }\n    return render;\n  };\n\n  // 重复执行时清理旧的事件绑定，私有方法\n  Flow.prototype._cleanup = function(elem, scrollElem){\n    scrollElem.off('scroll.flow').off('scroll.lazyimg');\n    elem.find('.layui-flow-more').find('a').off('click.flow');\n  }\n\n  //暴露接口\n  const flow = new Flow();\n  export default flow;\n  export { flow };\n\n"],"names":[],"mappings":"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"}