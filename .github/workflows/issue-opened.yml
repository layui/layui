name: Issue Opened

on:
  issues:
    types: [opened, edited]

permissions:
  contents: read

jobs:
  issue-opened:
    permissions:
      issues: write
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: content template
        id: template
        run: |
          contribute="è¯¦è§ï¼šðŸ€ [Layui Issue è´¡çŒ®æŒ‡å—](https://github.com/layui/layui/blob/main/CONTRIBUTING.md)"
          echo "CONTRIBUTING=$contribute" >> $GITHUB_ENV

      - name: check invalid
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const config = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            };

            const payload = context.payload;
            const isCreatedByBot = payload.sender.type === 'Bot';
            const issue = payload.issue;
            const isValid = issue.body?.includes('layui-issue-template');

            // è·³è¿‡ closed çŠ¶æ€çš„ issues
            if (issue.state === 'closed') {
              return console.log('Issue is closed.');
            }

            // è‹¥ä¿®æ”¹çš„ä¸æ˜¯å†…å®¹ï¼Œåˆ™ä¸å¿…æ ¡éªŒ
            if (payload.action === 'edited') {
              if (payload.changes && !payload.changes.body.from) {
                return console.log('Edited fields exclude "body".');
              }
            }

            // ä¸ç¬¦åˆè§„åˆ™æˆ–ç”±æœºå™¨äººåˆ›å»º
            if (isCreatedByBot || !isValid) {
              if (!isCreatedByBot) {
                github.rest.issues.createComment({
                  ...config,
                  body: `@${payload.sender.login} ä½ å¥½ï¼Œä¸ºäº†æå‡æ²Ÿé€šæ•ˆçŽ‡ï¼Œæˆ‘ä»¬å¯¹ Issue åˆ¶å®šäº†ä¸¥æ ¼çš„è¦æ±‚ï¼Œä½ çš„ Issue å› ä¸ç¬¦åˆè§„å®šè€Œè¢«è‡ªåŠ¨å…³é—­ã€‚
              å»ºè®®ä½ åœ¨ä¸‹æ¬¡åˆ›å»º Issue æ—¶ï¼Œéµå¾ªç›¸åº”è§„èŒƒå’Œç¤¾åŒºè¡Œä¸ºå‡†åˆ™ã€‚è°¢è°¢ã€‚\n > ${process.env.CONTRIBUTING}`
                });
              }
              // ç»™ issue æ·»åŠ æŒ‡å®šæ ‡ç­¾å’Œå…³é—­
              github.rest.issues.addLabels({
                ...config,
                labels: ['invalid']
              });
              github.rest.issues.update({
                ...config,
                state: 'closed'
              });
            }
